# tasks/install-java-maven-go.yml
- name: Debug OS information
  become: yes
  ansible.builtin.debug:
    msg: "OS={{ ansible_facts.distribution }} {{ ansible_facts.distribution_version }}"

- name: Install Java 17 + Go (Debian/Ubuntu)
  become: yes
  ansible.builtin.apt:
    name:
      - openjdk-17-jdk
      - golang
    state: present
    update_cache: yes
  when: is_debian

# RHEL/CentOS/Fedora/Amazon
- name: Install Java 17 + Go (RHEL/CentOS/Fedora/Amazon)
  become: yes
  ansible.builtin.dnf:
    name:
      - "{{ 'java-17-amazon-corretto' if is_amazon_linux else 'java-17-openjdk' }}"
      - "{{ 'java-17-amazon-corretto-devel' if is_amazon_linux else 'java-17-openjdk-devel' }}"
      - golang
    state: present
    disablerepo: "pgdg*"
  when: is_rpm

# Detect JAVA_HOME dynamically
- name: Discover JAVA_HOME
  become: yes
  ansible.builtin.shell: |
    set -e
    JAVA_BIN="$(readlink -f "$(command -v java)" || which java)"
    # /usr/lib/jvm/.../bin/java -> strip /bin/java
    dirname "$(dirname "$JAVA_BIN")"
  register: _java_home
  changed_when: false

- name: Configure java profile
  become: yes
  ansible.builtin.copy:
    dest: /etc/profile.d/jdk17.sh
    mode: '0644'
    content: |
      export JAVA_HOME="{{ _java_home.stdout | trim }}"
      export PATH="$JAVA_HOME/bin:$PATH"

# Maven via tarball (works on both families)
- name: Download & unpack Maven
  become: yes
  ansible.builtin.unarchive:
    src: "https://dlcdn.apache.org/maven/maven-3/{{ maven_version }}/binaries/apache-maven-{{ maven_version }}-bin.tar.gz"
    dest: "{{ crdb_file_location }}"
    remote_src: yes

- name: Symlink Maven
  become: yes
  ansible.builtin.file:
    src: "{{ crdb_file_location }}/apache-maven-{{ maven_version }}"
    dest: "{{ crdb_file_location }}/maven"
    state: link

- name: Configure Maven profile
  become: yes
  ansible.builtin.copy:
    dest: /etc/profile.d/maven.sh
    mode: '0755'
    content: |
      export M2_HOME="{{ crdb_file_location }}/maven"
      export MAVEN_HOME="{{ crdb_file_location }}/maven"
      export PATH="$PATH:$M2_HOME/bin"

