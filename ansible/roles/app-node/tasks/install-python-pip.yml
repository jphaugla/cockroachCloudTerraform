# tasks/install-packages.yml
# Installing and Configuring packages

# Debian/Ubuntu
- name: Install build/dev packages (Debian/Ubuntu)
  become: yes
  ansible.builtin.apt:
    name:
      - build-essential
      - libpq-dev
      - python3
      - python3-dev
      - python3-pip
      - python3-venv
      - postgresql-server-dev-all
    state: present
    update_cache: yes
  when: is_debian

# Refresh cache but skip PGDG repos to avoid pgdg18 metadata failures
- name: Refresh DNF cache (without PGDG)
  become: yes
  ansible.builtin.dnf:
    update_cache: yes
    disablerepo: "pgdg*"
  when: is_rpm

# Enable CRB (Rocky/Alma/Fedora) or ignore if not present (RHEL/Amazon)
- name: Enable CRB/Codeready Builder (best effort)
  become: yes
  ansible.builtin.command: dnf config-manager --set-enabled crb
  changed_when: false
  failed_when: false
  when: is_rpm

# RHEL/CentOS/Fedora/Amazon â€” install without PGDG repos
- name: Install build/dev packages (RHEL/CentOS/Fedora/Amazon)
  become: yes
  ansible.builtin.dnf:
    name:
      - gcc
      - gcc-c++
      - libpq-devel
      - python3
      - python3-devel
      - python3-pip
      - postgresql-devel
    state: present
    use_backend: "{{ _dnf_backend_pkgs | default('auto') }}"
    disablerepo: "pgdg*"
  when: is_rpm

# Python DB drivers
- name: Install sqlalchemy and psycopg2
  become: yes
  ansible.builtin.pip:
    name:
      - "sqlalchemy~=1.4"
      - sqlalchemy-cockroachdb
      - psycopg2
    executable: pip3
