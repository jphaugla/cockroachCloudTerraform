---
# roles/replicator-molt/tasks/install-employee-sample.yml

- name: Check if employees.sql.gz already exists
  stat:
    path: /tmp/employees.sql.gz
  register: employees_dump

- name: Download employees sample database dump (only if missing)
  become: yes
  get_url:
    url: https://raw.githubusercontent.com/neondatabase-labs/postgres-sample-dbs/main/employees.sql.gz
    dest: /tmp/employees.sql.gz
    mode: "0644"
    force: no
  when: not employees_dump.stat.exists
  retries: 5
  delay: 10
  register: download_result
  until: download_result is succeeded

- name: Create employees database if not exists
  become: yes
  shell: |
    sudo -u postgres psql -tAc "SELECT 1 FROM pg_database WHERE datname='employees'" \
      | grep -q 1 \
      || sudo -u postgres psql -c "CREATE DATABASE employees;"
  args:
    executable: /bin/bash
    chdir: /tmp

- name: Load employees dump into employees DB (plain SQL)
  become: yes
  shell: |
    gunzip -c /tmp/employees.sql.gz | sudo -u postgres psql --dbname=employees
  args:
    executable: /bin/bash
    chdir: /tmp
  register: restore_result
  failed_when: restore_result.rc not in [0,1]

- name: Move the schema to public
  become: yes
  shell: |
    sudo -u postgres psql --dbname=employees <<-'SQL'
      \i /tmp/moveSchema.sql
    SQL
  args:
    executable: /bin/bash
    chdir: /tmp

