# tasks/install-postgres-rhel.yml
# For RHEL/CentOS/Rocky/Alma (EL8/EL9)

- name: Ensure we’re on a RHEL-like distro
  ansible.builtin.assert:
    that: ansible_facts.os_family == "RedHat"
    fail_msg: "This task file is for RHEL/CentOS/Rocky/Alma only."

# EL8/EL9 ship a module stream that conflicts with PGDG. Disable it first.
- name: Disable built-in PostgreSQL module (EL8/EL9)
  become: yes
  ansible.builtin.command: dnf -qy module disable postgresql
  register: disable_mod
  failed_when: false            # don’t fail if already disabled / not applicable
  changed_when: disable_mod.rc == 0
  when: ansible_facts.os_family == "RedHat"

# Trust the PGDG repo RPM GPG key before installing the repo RPM
- name: Import PGDG RPM GPG key
  become: yes
  ansible.builtin.rpm_key:
    state: present
    key: https://download.postgresql.org/pub/repos/yum/RPM-GPG-KEY-PGDG

# Install the PGDG repository RPM (auto-picks EL major + arch)
- name: Install PGDG repo RPM
  become: yes
  ansible.builtin.dnf:
    name: "https://download.postgresql.org/pub/repos/yum/reporpms/EL-{{ ansible_facts.distribution_major_version }}-{{ ansible_facts.architecture }}/pgdg-redhat-repo-latest.noarch.rpm"
    state: present

# Optionally disable unneeded PGDG repos so cache refresh won’t trip on pgdg18 mirrors
- name: Disable unneeded PGDG repos (keep pgdg15 only)
  become: yes
  ansible.builtin.ini_file:
    path: /etc/yum.repos.d/pgdg-redhat-all.repo
    section: "{{ item }}"
    option: enabled
    value: '0'
  loop:
    - pgdg16
    - pgdg17
    - pgdg18
  ignore_errors: yes

# Refresh DNF metadata now that only the required repo is enabled
- name: Refresh DNF cache
  become: yes
  ansible.builtin.dnf:
    update_cache: yes

# Install PostgreSQL 15 server from the PGDG repo
- name: Install postgresql15-server (from pgdg15)
  become: yes
  ansible.builtin.dnf:
    name: postgresql15-server
    state: present
    enablerepo: pgdg15

# Initialize the database if not already initialized
- name: Initialize PostgreSQL database (EL)
  become: yes
  ansible.builtin.command:
    cmd: /usr/pgsql-15/bin/postgresql-15-setup initdb
  args:
    creates: /var/lib/pgsql/15/data/postgresql.conf

# Provide your pg_hba.conf (ensure this file exists next to your play/role)
- name: Copy pg_hba.conf
  become: yes
  ansible.builtin.copy:
    src: pg_hba.conf
    dest: /var/lib/pgsql/15/data/pg_hba.conf
    owner: postgres
    group: postgres
    mode: '0600'
  notify: Restart PostgreSQL 15

# Replication tuning
- name: Configure PostgreSQL replication settings
  become: yes
  ansible.builtin.blockinfile:
    path: /var/lib/pgsql/15/data/postgresql.conf
    marker: "# {mark} ANSIBLE MANAGED POSTGRES REPLICATION CONFIG"
    block: |
      wal_level = logical
      max_wal_senders = 3
      max_replication_slots = 3
      wal_keep_size = 1024
      hot_standby = on
  notify: Restart PostgreSQL 15

# Start & enable service
- name: Start and enable PostgreSQL 15
  become: yes
  ansible.builtin.systemd:
    name: postgresql-15
    state: started
    enabled: yes

# psycopg2 for your Python tooling (system Python3)
- name: Install psycopg2-binary
  become: yes
  ansible.builtin.pip:
    name: psycopg2-binary
    executable: pip3

