# Cockroach Cloud Terraform

This repository contains Terraform configurations to provision and manage a CockroachDB Advanced cluster on Cockroach Cloud, along with the necessary AWS infrastructure for PrivateLink connectivity and an application node.

## Repository Structure

- **providers.tf**: Configures Terraform providers for AWS and CockroachDB.
- **variables.tf**: Declares all input variables for customizing the deployment.
- **locals.tf**: Defines computed values and fallbacks (e.g., `effective_regions`).
- **data.tf**: Data sources for AWS availability zones, AWS caller identity, and CockroachDB folder lookup.
- **vpc.tf**: AWS VPC and Internet Gateway resources.
- **subnets.tf**: Public and private subnet definitions.
- **routing.tf**: Route tables and associations.
- **security_groups.tf**: Security Group modules, including `sg_application`.
- **network_interfaces.tf**: Application network interface configuration.
- **privatelink.tf**: Resources to expose, connect, and trust the CockroachDB PrivateLink service:
  - `cockroach_private_endpoint_services`
  - `aws_vpc_endpoint`
  - `cockroach_private_endpoint_trusted_owner`
  - `cockroach_private_endpoint_connection`
- **cluster.tf**: CockroachDB cluster, allow‑list entries, and SQL user creation.
- **outputs.tf**: Exposes useful values such as `crdb_sql_dns` and application connection strings.

## Prerequisites

1. **Terraform**: v1.5+ installed.
2. **AWS credentials**: Configure via environment variables or `~/.aws/credentials`.
3. **Cockroach Cloud API Key**:
   ```bash
   export COCKROACH_API_KEY="<your_api_key>"
   ```
4. **Environment Variables** (optional, if using a custom .env loader):
   ```bash
   export AWS_REGION="us-east-2"
   export COCKROACH_API_URL="https://api.cockroachlabs.cloud"
   ```

## Quick Start

1. **Initialize Terraform**
   ```bash
   terraform init
   ```
2. **Plan**
   ```bash
   terraform plan -out tfplan
   ```
3. **Apply**
   ```bash
   terraform apply -auto-approve tfplan
   ```

## Post-Deployment

### Retrieve Cluster Certificates

Use the `cockroach_cluster_cert` data source and `local_file` to download the CA certificate:

```hcl
data "cockroach_cluster_cert" "cluster" {
  id = cockroach_cluster.advanced.id
}

resource "local_file" "cluster_ca" {
  filename = "./certs/${cockroach_cluster.advanced.name}-ca.crt"
  content  = data.cockroach_cluster_cert.cluster.cert
}
```

After `terraform apply`, your CA cert will be in `./certs/`.

### Obtain PrivateLink DNS

The SQL DNS hostname is exposed as an output:

```bash
terraform output -raw crdb_sql_dns
```

This name resolves over AWS PrivateLink once the VPC endpoint’s private DNS is enabled.

### Connect From Application Node

On your EC2 app host, set:

```bash
export DATABASE_URL="postgresql://<user>:<pass>@$(terraform output -raw crdb_sql_dns):26257/defaultdb?sslmode=verify-full&sslrootcert=/home/ec2-user/certs/ca.crt"
cockroach sql --url="$DATABASE_URL"
```

### Running Load Generator

A Node.js script `scripts/run-load.js` generates sample load via the Next.js API:

```bash
npm install
npm run dev                    # in one terminal, start Next.js on 0.0.0.0:3000
npm run load -- 100 50 30      # in another terminal: sessions=100, orders=50, restock=30s
```

## Variables

Core variables are declared in `variables.tf`. You can override via:
- `terraform.tfvars`
- `-var 'key=value'` flags
- Environment variables `TF_VAR_<key>`

Notable variables:

| Variable             | Description                                      | Default         |
|----------------------|--------------------------------------------------|-----------------|
| `regions`            | List of `{ name, node_count }` for the cluster   | Fallback to `aws_region` & `node_count` |
| `aws_region`         | AWS region for all resources                     | `us-east-2`     |
| `node_count`         | Nodes per region if `regions` is empty           | `3`             |
| `include_app`        | Whether to provision the EC2 application node    | `"yes"`/"no" |
| `resource_tags`      | Map of tags applied to all AWS resources         | `{}`            |

## Cleanup

To destroy everything:

```bash
terraform destroy -auto-approve
```

> **Note:** The `cockroach_private_endpoint_services` resource has `prevent_destroy = true` by default to avoid orphaning PrivateLink services. You must manually remove that resource block or disable `prevent_destroy` if you truly want to tear down the PrivateLink service.

---

_This README was autogenerated by the project maintainer._

